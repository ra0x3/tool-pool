# Calculator WASM module configuration
version: "1.0"

metadata:
  name: "Calculator MCP Server"
  description: "WASM-based calculator with strict security policy"

server:
  name: wasm-calculator
  version: 0.1.0
  bind: 127.0.0.1
  port: 3000
  debug: false
  log_level: info

transport:
  type: stdio
  settings:
    buffer_size: 32768

# Security policy for calculator WASM module
policy:
  version: "1.0"
  description: "Strict sandbox policy for calculator"

  core:
    # No network access for calculator
    network:
      deny:
        - host: "*"

    # Only allow access to temp directory for calculations
    storage:
      allow:
        - uri: "fs:///tmp/calculator/**"
          access: ["read", "write"]
      deny:
        - uri: "fs:///**"
          access: ["read", "write", "execute"]

    # No environment variables
    environment:
      deny:
        - key: "*"

    # Strict resource limits
    resources:
      limits:
        cpu: "100m"       # 0.1 core
        memory: "32Mi"    # 32 MiB
        execution_time: "5s"  # 5 seconds max

  # MCP-specific permissions
  mcp:
    tools:
      allow:
        - name: "add"
          max_calls_per_minute: 1000
        - name: "subtract"
          max_calls_per_minute: 1000
        - name: "multiply"
          max_calls_per_minute: 1000
        - name: "divide"
          max_calls_per_minute: 1000
      deny:
        - name: "*"  # Deny all other tools

    prompts:
      deny:
        - name: "*"  # Calculator doesn't need prompts

    resources:
      deny:
        - uri: "*"  # No resource access
          operations: ["read", "write", "delete"]

    transport:
      stdio: true
      http:
        allowed_hosts: []
      websocket: false

runtime:
  type: wasmtime
  wasm:
    # module_path: ./target/wasm32-unknown-unknown/release/calculator.wasm
    fuel: 10000000  # Legacy fuel configuration (kept for compatibility)
    memory_pages: 16  # 1MB memory
    cache: true
    cache_dir: ./.wasm-cache

    # Modern metering configuration
    metering:
      enabled: true
      max_compute_units: 10_000_000   # 10M units for calculations
      display_format: minimal         # Simple output for calculator

      # Memory limits with defense-in-depth
      memory_limits:
        max_memory: "32Mi"            # 32 MiB max
        soft_limit: "24Mi"            # Warn at 24 MiB
        max_tables: 5                 # Limited tables
        max_instances: 1              # Single instance

      # No real-time monitoring for simple calculator
      enable_monitoring: false

      # Strict enforcement for security
      enforcement: strict

      # Conservative limits for calculator
      limits:
        soft_limit: 8_000_000         # Warn at 8M units
        hard_limit: 10_000_000        # Stop at 10M units

      # Per-operation quotas
      quotas:
        per_request: 100_000          # 100K per calculation
        per_minute: 10_000_000        # 10M per minute
        per_hour: 100_000_000         # 100M per hour
  limits:
    cpu: "100m"
    memory: "32Mi"
    execution_time: "5s"
    max_requests_per_minute: 1000

mcp:
  protocol_version: "2024-11-05"

  tools:
    - name: add
      description: "Add two numbers"
      input_schema:
        type: object
        properties:
          a:
            type: number
            description: "First number"
          b:
            type: number
            description: "Second number"
        required: ["a", "b"]

    - name: subtract
      description: "Subtract two numbers"
      input_schema:
        type: object
        properties:
          a:
            type: number
            description: "First number"
          b:
            type: number
            description: "Second number"
        required: ["a", "b"]

    - name: multiply
      description: "Multiply two numbers"
      input_schema:
        type: object
        properties:
          a:
            type: number
            description: "First number"
          b:
            type: number
            description: "Second number"
        required: ["a", "b"]

    - name: divide
      description: "Divide two numbers"
      input_schema:
        type: object
        properties:
          a:
            type: number
            description: "Dividend"
          b:
            type: number
            description: "Divisor (non-zero)"
        required: ["a", "b"]

  capabilities:
    tools: true
    prompts: false
    resources: false
    logging: true

# Distribution configuration for OCI registry publishing
distribution:
  # OCI registry URI for calculator bundle
  registry: "ghcr.io/ra0x3/mcpkit-calculator"

  # Version (uses server.version by default)
  version: "0.1.0"

  # Tags to apply
  tags:
    - "latest"
    - "v0.1.0"

  # Bundle metadata
  metadata:
    authors:
      - "mcpkit-rs contributors"
    license: "Apache-2.0"
    repository: "https://github.com/ra0x3/mcpkit-rs"
    keywords:
      - "calculator"
      - "wasm"
      - "mcp"
      - "wasmtime"
    homepage: "https://github.com/ra0x3/mcpkit-rs"
    documentation: "https://github.com/ra0x3/mcpkit-rs/tree/main/examples/wasm/wasmtime/calculator"

  # Files to include in bundle
  include:
    - "calculator.wasm"
    - "config.yaml"

  # Registry authentication (using environment variables)
  auth:
    username: "${GITHUB_USER}"
    password: "${GITHUB_TOKEN}"