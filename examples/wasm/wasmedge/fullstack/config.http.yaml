# Configuration for WasmEdge Fullstack Example
version: "1.0"

metadata:
  name: "fullstack-example"
  description: "Fullstack WasmEdge MCP server example with multiple tools"
  author: "mcpkit-rs"

server:
  name: "fullstack-server"
  version: "0.1.0"
  description: "A fullstack MCP server with data management tools"
  bind: "0.0.0.0"
  port: 3000
  request_timeout: 60
  debug: false
  log_level: "info"

transport:
  type: http
  settings:
    cors_enabled: true
    max_body_size: 10485760  # 10MB
    compression: true

runtime:
  type: wasmedge
  wasm:
    memory_pages: 1024  # 64MB
    fuel: 10000000      # Legacy configuration (kept for compatibility)

    # Environment variables that will be available to the WASM module
    env_vars:
      - name: DATABASE_URL
        value: "${DATABASE_URL}"  # Will be resolved from host environment

    # Modern metering configuration for WasmEdge
    metering:
      enabled: true
      max_compute_units: 100_000_000  # 100M units (gas in WasmEdge)
      display_format: detailed         # Show detailed metrics for development

      # Memory limits with defense-in-depth
      memory_limits:
        max_memory: "256Mi"           # 256 MiB for fullstack operations
        soft_limit: "200Mi"           # Warn at 200 MiB
        max_tables: 20                # More tables for complex app
        max_instances: 10             # Support multiple instances

      # Enable monitoring for development
      enable_monitoring: true

      # Sampling configuration
      sampling:
        unit_threshold: 100_000       # Sample every 100K units
        time_threshold_ms: 100        # Sample every 100ms
        adaptive: true                # Adapt to workload

      # Warning mode for development
      enforcement:
        warning:
          threshold: 0.85             # Warn at 85% usage

      # Generous limits for fullstack app
      limits:
        soft_limit: 85_000_000        # Warn at 85M units
        hard_limit: 100_000_000       # Stop at 100M units

      # Fullstack operation quotas
      quotas:
        per_request: 10_000_000       # 10M per request
        per_minute: 500_000_000       # 500M per minute
        per_hour: 10_000_000_000      # 10B per hour

  limits:
    execution_time: "30s"
    memory: "256Mi"     # Updated to match metering config
    cpu: "1000m"

mcp:
  protocol_version: "2024-11-05"
  capabilities:
    - tools
    - prompts
    - resources
    - logging

policy:
  version: "1.0"
  # Tools configuration should be at root level, not under core
  tools:
    allow:
      - name: "test_connection"
      - name: "fetch_todos"
      - name: "create_todo"
      - name: "update_todo"
      - name: "delete_todo"
      - name: "batch_process"
      - name: "search_todos"
      - name: "db_stats"
      - name: "read_wal"
      - name: "file_read"
      - name: "file_write"
      - name: "file_list"
    deny: []
  core:
    network:
      allow:
        - host: "localhost:*"
        - host: "127.0.0.1:*"
      deny:
        - host: "*"
    storage:
      allow:
        - uri: "fs:///tmp/wasm-fs-test/allowed/**"
          access: ["read", "write"]
        - uri: "fs:///tmp/**"
          access: ["read", "write"]
        - uri: "/var/tmp/**"
          access: ["read", "write"]
      deny:
        - uri: "fs:///tmp/wasm-fs-test/forbidden/**"
          access: ["read", "write"]
        - uri: "/etc/**"
          access: ["read", "write"]
        - uri: "/usr/**"
          access: ["read", "write"]
        - uri: "/sys/**"
          access: ["read", "write"]
    environment:
      allow:
        - key: "DATABASE_URL"  # Required for PostgreSQL connection
        - key: "HOME"
        - key: "USER"
        - key: "TMPDIR"
        - key: "WASMEDGE_*"
      deny:
        - key: "*_TOKEN"
        - key: "*_KEY"
        - key: "*_SECRET"
        - key: "*_PASSWORD"  # But DATABASE_URL is allowed despite containing password
  resources:
    execution:
      max_fuel: 10000000
      timeout_seconds: 30
    memory:
      max_pages: 1024
    capabilities:
      - filesystem_read
      - filesystem_write
      - network_connect